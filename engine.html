<!DOCTYPE html>

<html>

<head>
    <title>Physics Sim</title>

    <link rel="stylesheet" type="text/css" href="css/styles.css" />

    <script type="text/javascript" src="js/three.min.js"></script>
    <script type="text/javascript" src="js/physi.js"></script>

    <script type="text/javascript">

'use strict';

Physijs.scripts.worker = 'js/physijs_worker.js';
//Physijs.scripts.ammo = '/js/ammo.js';

var renderer, scene, camera, am_light, dir_light, loader, ground_material, ground, box, framesLeft;

function initScene() {
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setClearColor( 0xefd1b5 ); // redish sky
    //renderer.setClearColor( 0x9999ff ); // blue
    renderer.setPixelRatio( window.devicePixelRatio );
    renderer.setSize( window.innerWidth, window.innerHeight );
    document.getElementById( 'viewport' ).appendChild( renderer.domElement );

    scene = new Physijs.Scene;
    scene.setGravity(new THREE.Vector3( 0, -30, 0 ));
    scene.fog = new THREE.FogExp2( 0xefd1b5, 0.0025 ); // redish sky
    //scene.fog = new THREE.FogExp2( 0x9999ff, 0.001 ); // blue

    camera = new THREE.PerspectiveCamera(
        35,
        window.innerWidth / window.innerHeight,
        1,
        1000
    );
    // camera position is updated every frame
    scene.add( camera );

    // ambient light
    am_light = new THREE.AmbientLight( 0x444444 );
    scene.add( am_light );

    // directional light
    dir_light = new THREE.DirectionalLight( 0xFFFFFF );
    dir_light.position.set( 200, 300, -50 );
    dir_light.target.position.copy( scene.position );
    dir_light.castShadow = true;
    dir_light.shadowCameraLeft = -500;
    dir_light.shadowCameraTop = -500;
    dir_light.shadowCameraRight = 500;
    dir_light.shadowCameraBottom = 500;
    dir_light.shadowCameraNear = 80;
    dir_light.shadowCameraFar = 2000;
    dir_light.shadowBias = -.001;
    dir_light.shadowMapWidth = dir_light.shadowMapHeight = 2048;
    dir_light.shadowDarkness = .85;
    scene.add( dir_light );

    // Loader
    loader = new THREE.TextureLoader();

    // Materials
    ground_material = Physijs.createMaterial(
            new THREE.MeshLambertMaterial({ map: loader.load( 'images/grass.png' )}),
            .9, // high friction
            .2 // low restitution
            );
    ground_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
    ground_material.map.repeat.set( 600, 600 );

    renderer.shadowMap.enabled = true;

    // Ground
    ground = new Physijs.BoxMesh(
            new THREE.BoxGeometry(20000, 1, 20000),
            ground_material,
            0, // mass
            { restitution: .2, friction: .8 }
            );
    ground.position.y = -.5;
    ground.receiveShadow = true;
    scene.add( ground );

    // Box
    box = new Physijs.BoxMesh(
        new THREE.CubeGeometry( 5, 5, 5 ),
        new THREE.MeshLambertMaterial({ color: 0x888888 }),
        55, // mass
        { restitution: .9, friction: .1 }
    );
    box.receiveShadow = true;
    box.castShadow = true;
    scene.add( box );

    setupStartPos();
    requestAnimationFrame( render );
};

function rand(min,max,interval) {
    if (typeof(interval)==='undefined') interval = 1;
    var r = Math.floor(Math.random()*(max-min+interval)/interval);
    return r*interval+min;
}

function cameraChase(cam, mesh) {
    var relativeOffset = new THREE.Vector3( 80, 60, 90 );
    var cameraOffset = relativeOffset.add( mesh.position );
    cam.position.x = cameraOffset.x;
    cam.position.y = cameraOffset.y;
    cam.position.z = cameraOffset.z;
    cam.lookAt( mesh.position );
}

function setupStartPos() {
    box.position.set( 20, 15, 30 );
    box.setAngularVelocity( new THREE.Vector3(
                rand( -7, 7 ), rand( -7, 7 ), rand( -7, 7 ) ) );
    box.setLinearVelocity( new THREE.Vector3(
            rand( -60, 60 ), rand( 12, 120 ), rand( -60, 60 )) );
    framesLeft = 400
}

function render() {
    if (framesLeft-- > 0) {
        box.__dirtyRotation = true;
        box.__dirtyPosition = true;
        scene.simulate(); // run physics
    } else {
        setupStartPos();
    }
    cameraChase( camera, box );
    renderer.render( scene, camera ); // render the scene
    requestAnimationFrame( render );
};

window.onload = initScene;

    </script>
</head>

<body>
    <div id="viewport"></div>
</body>
</html>
